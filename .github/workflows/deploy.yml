# yaml-language-server: $schema='none'

name: Deploy
on:
  push:
    branches:
      - main
      - chore-ci-deployments

jobs:
  # test:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/setup-node@v4
  #       with:
  #         node-version: 20
  #         cache: "npm"
  #     - name: Install dependencies
  #       env:
  #         NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
  #       run: |
  #         npm ci
  #         npm run install:ev-enclave
  #     - name: Run tests
  #       run: npm test
  #     - name: Run Lint
  #       run: npm run lint
  #     - name: Check Types
  #       run: npm run build
  deploy-preprod:
    runs-on: ubuntu-latest
    # needs: test
    environment:
      name: preproduction
      url: https://wallet-service-preprod.app-32d15525a875.enclave.evervault.com
    env:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      SIGNING_CERT: ${{ secrets.SIGNING_CERT }}
      SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
      EV_API_KEY: ${{ secrets.EV_API_KEY }}
      EV_APP_UUID: ${{ secrets.EV_APP_UUID }}
    steps:
      - uses: actions/checkout@v4
      - name: Install ev
        run: npm run install:ev-enclave
      - name: Add signing cert and key
        run: |
          echo "${{ secrets.SIGNING_CERT }}" > /dev/shm/cert.pem
          echo "${{ secrets.SIGNING_KEY }}" > /dev/shm/key.pem
      - name: Build & Deploy
        run: |
          ev enclave \
            deploy \
            --verbose \
            --no-cache \
            --build-arg ENVIRONMENT=preproduction \
            --build-secret id=NPM_TOKEN \
            --signing-cert /dev/shm/cert.pem \
            --private-key /dev/shm/key.pem \
            --config enclave.preprod.toml \
            --reproducible
      - name: Remove signing cert
        if: always()
        run: rm -f /dev/shm/cert.pem /dev/shm/key.pem
  # deploy-production:
  #   runs-on: ubuntu-latest
  #   needs: deploy-preprod
  #   environment:
  #     name: production
  #     url: https://wallet-service-prod.app-32d15525a875.enclave.evervault.com
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Install ev
  #       env:
  #         NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
  #       run: npm run install:ev-enclave
  #     - name: Build & Deploy
  #       env:
  #         EV_API_KEY: ${{ secrets.EV_API_KEY }}
  #         NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
  #       run: |
  #         echo "${{ secrets.SIGNING_CERT }}" > /dev/shm/cert.pem
  #         echo "${{ secrets.SIGNING_KEY }}" > /dev/shm/key.pem
  #         ev enclave deploy \
  #           --build-arg ENVIRONMENT=production \
  #           --no-cache \
  #           --config enclave.prod.toml \
  #           --reproducible \
  #           -- "--build-secret id=NPM_TOKEN"
  #         rm -f /dev/shm/cert.pem /dev/shm/key.pem
